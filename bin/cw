#!/usr/bin/env bash
# claude-workspace (cw) - Claude Code multi-repo workspace manager
set -euo pipefail

CW_VERSION="0.2.0"
CW_DIR="${CW_HOME:-$HOME/.claude-workspace}"
CW_LIB_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../lib" && pwd)"

# Load libraries (order matters for dependencies)
source "$CW_LIB_DIR/utils.sh"
source "$CW_LIB_DIR/i18n.sh"
source "$CW_LIB_DIR/registry.sh"
source "$CW_LIB_DIR/setup.sh"
source "$CW_LIB_DIR/launch.sh"
source "$CW_LIB_DIR/list.sh"
source "$CW_LIB_DIR/info.sh"
source "$CW_LIB_DIR/new.sh"
source "$CW_LIB_DIR/menu.sh"
source "$CW_LIB_DIR/update.sh"
source "$CW_LIB_DIR/lang.sh"

usage() {
  cat <<EOF
$(bold "claude-workspace (cw)") v${CW_VERSION}
$(t "usage_title")

$(bold "$(t "usage"):")
  cw                    $(t "usage_launch_or_menu")
  cw new [name]         $(t "usage_new")
  cw resume             $(t "usage_resume")
  cw setup              $(t "usage_setup")
  cw launch [name]      $(t "usage_launch")
  cw list               $(t "usage_list")
  cw info [name]        $(t "usage_info")
  cw add-dir <path>     $(t "usage_add_dir")
  cw forget             $(t "usage_forget")
  cw scan               $(t "usage_scan")
  cw update             $(t "usage_update")
  cw lang [en|ja]       $(t "usage_lang")
  cw version            $(t "usage_version")

$(bold "$(t "usage_examples"):")
  cw                    # $(t "example_anywhere")
  cw new store360       # ~/WorkingProjects/store360/ $(t "example_create_setup")
  cw resume             # $(t "usage_resume")
  cw launch Store360    # Launch by name
EOF
}

# Scan WorkingProjects/ for unregistered workspaces
cmd_scan() {
  require_jq

  local search_base="${WORKING_PROJECTS_DIR:-$HOME/WorkingProjects}"

  echo ""
  echo "$(bold "$(t "workspace_scan")")"
  echo "  $(dim "$(t "search"): $search_base")"
  echo ""

  if [[ ! -d "$search_base" ]]; then
    warn "$(t "directory") $(t "not_found"): $search_base"
    exit 0
  fi

  local found=0
  local registered=0

  while IFS= read -r ws_file; do
    local ws_dir ws_name
    ws_dir=$(dirname "$ws_file")
    ws_name=$(ws_get "$ws_file" '.name')
    found=$((found + 1))

    # Check if already in registry
    local existing
    existing=$(registry_get_by_name "$ws_name")

    if [[ -n "$existing" && "$existing" == "$ws_dir" ]]; then
      info "$(t "skip") ($(t "registered")): $ws_name"
    else
      registry_add "$ws_name" "$ws_dir"
      success "$(t "register"): $ws_name  $(dim "$ws_dir")"
      registered=$((registered + 1))
    fi
  done < <(find "$search_base" -maxdepth 2 -name ".workspace.json" 2>/dev/null | sort)

  echo ""
  if [[ $found -eq 0 ]]; then
    info "$(t "workspace_not_found")"
  else
    info "${found} $(t "files") - ${registered} $(t "newly_registered")"
  fi
}

# Remove current directory's workspace from registry
cmd_forget() {
  local target_dir
  target_dir="$(pwd)"

  if ! is_workspace "$target_dir"; then
    error "$(t "not_a_workspace")"
    exit 1
  fi

  local ws_name
  ws_name=$(ws_get "$target_dir/$WORKSPACE_FILE" '.name')

  echo ""
  warn "「${ws_name}」$(t "remove_from_registry")"
  echo "  $(dim "$(t "files_remain")")"
  echo ""
  read -rep "  $(t "continue") [y/N]: " confirm
  [[ "$confirm" =~ ^[Yy]$ ]] || { info "$(t "cancel")"; exit 0; }

  registry_remove "$target_dir"
  success "$(t "deleted"): $ws_name"
}

main() {
  local cmd="${1:-}"

  case "$cmd" in
    # ──────────────────────────────
    # Smart launch: launch if in workspace, otherwise show menu
    # ──────────────────────────────
    "")
      if is_workspace "$(pwd)"; then
        cmd_launch
      else
        cmd_menu
      fi
      ;;

    # ──────────────────────────────
    # Commands
    # ──────────────────────────────
    new|n)        cmd_new "${@:2}" ;;
    resume|r)     cmd_menu ;;
    forget)       cmd_forget ;;
    scan)         cmd_scan ;;
    update)       cmd_update ;;
    lang)         cmd_lang "${@:2}" ;;

    # ──────────────────────────────
    # Standard commands
    # ──────────────────────────────
    setup)        cmd_setup "${@:2}" ;;
    launch)       cmd_launch "${@:2}" ;;
    list|ls)      cmd_list ;;
    info)         cmd_info "${@:2}" ;;
    add-dir)      cmd_add_dir "${@:2}" ;;
    version|-v|--version) echo "cw v${CW_VERSION}" ;;
    help|-h|--help) usage ;;

    *)
      error "$(t "invalid_command"): $cmd"
      echo ""
      usage
      exit 1
      ;;
  esac
}

main "$@"
